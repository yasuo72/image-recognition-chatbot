<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Recognition Chatbot</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        body {
            background: url('/static/background.jpg') no-repeat center center fixed;
            background-size: cover;
            font-family: Arial, sans-serif;
            cursor: url('/static/custom-cursor.png'), auto;
        }
        .chat-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.18);
            border-radius: 10px;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        .chat-marquee {
            background-color: rgba(255, 204, 0, 0.48);
            color: #333;
            padding: 5px 10px;
            border-radius: 10px 10px 0 0;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            overflow: hidden;
            position: relative;
        }
        .chat-marquee span {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 10s linear infinite;
        }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .chat-header {
            background-color: rgba(0, 123, 255, 0.49);
            color: rgba(255, 255, 255, 0.73);
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .chatbox {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            border-radius: 10px;
            background: rgba(86, 83, 83, 0.13);
            background: url('/static/chatbox-background.jpg') no-repeat center center fixed;
            background-size: cover;
            font-family: Arial, sans-serif;
            cursor: url('/static/custom-cursor.png'), auto;
            backdrop-filter: blur(10px);
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.2);
        }
        .message {
            margin: 10px 0;
            display: flex;
            align-items: flex-start;
        }
        .message.user .message-content {
            background-color: rgba(0, 123, 255, 0.76);
            color: rgba(255, 255, 255, 0.8);
            align-self: flex-end;
        }
        .message.bot .message-content {
            background-color: rgba(226, 227, 229, 0.76);
            color: #1f1e1e;
        }
        .message-content {
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 75%;
            word-break: break-word;
        }
        .message img {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 5px;
        }
        .form-group {
            display: flex;
            align-items: center;
        }
        .custom-file-upload {
            flex-grow: 1;
            padding: 10px;
            cursor: pointer;
            background-color: rgba(0, 123, 255, 0.79);
            color: rgba(255, 255, 255, 0.42);
            text-align: center;
            border-radius: 15px;
            margin-right: 5px;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
        .custom-file-upload:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        #image {
            display: none;
        }
        .btn-submit {
            padding: 10px 20px;
            background-color: rgba(0, 123, 255, 0.89);
            color: rgba(255, 255, 255, 0.77);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-submit:hover {
            background-color: rgba(0, 86, 179, 0.84);
            transform: scale(1.05);
        }
        .btn-submit:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.47);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.3s ease;
        }
        .btn-submit:hover:before {
            transform: translate(-50%, -50%) scale(1);
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #1100ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .chat-header {
                font-size: 1.2rem;
            }
            .btn-submit {
                font-size: 1rem;
                padding: 8px;
            }
            .custom-file-upload {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-marquee">
            <span>Under development...ðŸ˜‰</span>
        </div>
        <div class="chat-header">
            Predictor's Bot
        </div>
        <div class="chatbox" id="chatbox">
        </div>

        <form id="uploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="image" class="custom-file-upload">
                    Choose Image
                </label>
                <input type="file" id="image" name="image" accept="image/*" required>
                <button type="submit" class="btn-submit">Send</button>
            </div>
        </form>

        <div class="loader" id="loader"></div>

        <div class="form-group">
            <textarea id="input" rows="3" style="width: 100%;" placeholder="Type a message..."></textarea>
            <button id="send" class="btn-submit">Send</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const chatbox = document.getElementById('chatbox');
    const form = document.getElementById('uploadForm');
    const loader = document.getElementById('loader');
    const fileInput = document.getElementById('image');
    const fileLabel = document.querySelector('.custom-file-upload');
    const messagesList = document.getElementById('messages');

    // Function to add a message to the chatbox
    function addMessage(sender, content, isImage = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        if (isImage) {
            const img = document.createElement('img');
            img.src = content;
            messageContent.appendChild(img);
        } else {
            messageContent.textContent = content;
        }

        messageDiv.appendChild(messageContent);
        chatbox.appendChild(messageDiv);
        chatbox.scrollTop = chatbox.scrollHeight;  // Auto-scroll to the bottom
    }

    // Handle text message send
    document.getElementById('send').addEventListener('click', function () {
        const input = document.getElementById('input').value.trim();
        if (input === '') return;

        addMessage('user', `You: ${input}`);

        fetch('/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'  // Correct Content-Type
            },
            body: JSON.stringify({ message: input })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Response from server:', data);  // Debug print
            if (data.answer) {
                addMessage('bot', `Bot: ${data.answer}`);
            } else {
                addMessage('bot', 'Bot: Sorry, there was no response from the server.');
            }
            document.getElementById('input').value = '';  // Clear input field
        })
        .catch(error => {
            console.error('Error:', error);
            addMessage('bot', 'Bot: Sorry, an error occurred while processing your request.');
        });
    });

    // Handle image upload form submission
    form.addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData(this);
        loader.style.display = 'block';
        addMessage('user', 'Uploading image...');

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loader.style.display = 'none';

            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                const imgUrl = URL.createObjectURL(fileInput.files[0]);
                addMessage('user', imgUrl, true);
                addMessage('bot', `Description: ${data.description}\nResponse: ${data.response}`);
                fileInput.value = '';  // Clear file input
                fileLabel.textContent = 'Choose Image';  // Reset the label
            }
        })
        .catch(error => {
            loader.style.display = 'none';
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    });

    // Update label text when a file is selected
    fileInput.addEventListener('change', function () {
        if (fileInput.files.length > 0) {
            fileLabel.textContent = fileInput.files[0].name;
        } else {
            fileLabel.textContent = 'Choose Image';
        }
    });
});
</script>

</body>
</html>
